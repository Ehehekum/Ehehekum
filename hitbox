local lolz = {}
getgenv().emergency_stop = getgenv().emergency_stop or false
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Convert studs to a power multiplier (tweaked for smoother scaling)
function StudsIntoPower(studs)
    return math.clamp(studs * 4, 1, 50) -- Reduced multiplier to avoid anti-cheat flags
end

-- Randomize velocity slightly to mimic natural movement
function RandomizeVelocity(velocity)
    local noise = Vector3.new(
        math.random(-0.1, 0.1),
        math.random(-0.05, 0.05),
        math.random(-0.1, 0.1)
    )
    return velocity + noise
end

-- Main hitbox extension function
function lolz:ExtendHitbox(studs, duration)
    if getgenv().emergency_stop then
        getgenv().emergency_stop = false
    end

    local power = StudsIntoPower(studs)
    local startTime = tick()
    local connection

    -- Anti-cheat bypass: Cap velocity to avoid detection
    local maxSafeSpeed = 30 -- Typical Roblox walk speed is ~16, so we stay under anti-cheat thresholds
    local function getSafeVelocity(velocity)
        if velocity.Magnitude > maxSafeSpeed then
            return velocity.Unit * maxSafeSpeed
        end
        return velocity
    end

    -- Heartbeat loop for smooth hitbox extension
    connection = RunService.Heartbeat:Connect(function()
        if getgenv().emergency_stop or (tick() - startTime > duration) then
            connection:Disconnect()
            return
        end

        -- Ensure character and HumanoidRootPart exist
        local character = LocalPlayer.Character
        if not (character and character.Parent and character:FindFirstChild("HumanoidRootPart")) then
            return
        end

        local hrp = character.HumanoidRootPart
        local originalVelocity = hrp.Velocity
        local lookVector = hrp.CFrame.LookVector

        -- Extend hitbox using CFrame offset instead of velocity for smoother effect
        local offset = lookVector * power
        hrp.CFrame = hrp.CFrame + offset

        -- Restore velocity to avoid anti-cheat flags
        hrp.Velocity = getSafeVelocity(RandomizeVelocity(originalVelocity))

        -- Fake network packet to mask manipulation (simulates legit movement)
        local fakePosition = hrp.Position + Vector3.new(math.random(-0.2, 0.2), 0, math.random(-0.2, 0.2))
        hrp.Position = fakePosition

        -- Reset CFrame offset after rendering to maintain position
        RunService.RenderStepped:Wait()
        hrp.CFrame = CFrame.new(fakePosition)
        hrp.Velocity = getSafeVelocity(originalVelocity)
    end)
end

-- Stop hitbox extension
function lolz:StopExtendingHitbox()
    getgenv().emergency_stop = true
end

return lolz
