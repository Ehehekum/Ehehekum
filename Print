-- TopbarPlusClone (ModuleScript)
-- Simple topbar icon manager for client
-- Usage: local TP = require(pathTo.TopbarPlusClone); local icon = TP.newIcon("id", options)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local Topbar = {}
Topbar.__index = Topbar

-- helper: Event-like object
local function makeSignal()
    local conn = {}
    conn._cbs = {}
    function conn:Connect(fn) table.insert(self._cbs, fn); return {Disconnect = function() end} end
    function conn:Fire(...) for _,cb in ipairs(self._cbs) do
            task.spawn(cb, ...)
        end
    end
    function conn:Clear() self._cbs = {} end
    return conn
end

-- Create UI once per player
local function createGuiForPlayer(player)
    -- Wait for PlayerGui
    local pg = player:WaitForChild("PlayerGui")
    local sg = pg:FindFirstChild("TopbarPlusCloneGui")
    if sg then return sg end

    sg = Instance.new("ScreenGui")
    sg.Name = "TopbarPlusCloneGui"
    sg.ResetOnSpawn = false
    sg.Parent = pg

    -- Container frame anchored top-right (adjust as needed)
    local container = Instance.new("Frame")
    container.Name = "Container"
    container.Size = UDim2.new(0, 220, 0, 36)
    container.Position = UDim2.new(1, -236, 0, 8) -- top-right offset
    container.AnchorPoint = Vector2.new(0, 0)
    container.BackgroundTransparency = 1
    container.Parent = sg

    local uiList = Instance.new("UIListLayout")
    uiList.Name = "IconLayout"
    uiList.FillDirection = Enum.FillDirection.Horizontal
    uiList.Padding = UDim.new(0, 6)
    uiList.HorizontalAlignment = Enum.HorizontalAlignment.Right
    uiList.VerticalAlignment = Enum.VerticalAlignment.Center
    uiList.Parent = container

    return sg
end

-- Icon object metatable
local Icon = {}
Icon.__index = Icon

function Icon:Destroy()
    if self._root and self._root.Parent then
        self._root:Destroy()
    end
    if self._dropdownRoot and self._dropdownRoot.Parent then
        self._dropdownRoot:Destroy()
    end
    self._clicked:Clear()
    self._opened:Clear()
    self._closed:Clear()
end

function Icon:SetEnabled(enabled)
    self._enabled = enabled
    if self._btn then
        self._btn.AutoButtonColor = enabled
        self._btn.Visible = enabled
        self._btn.ImageTransparency = enabled and 0 or 0.6
    end
end

function Icon:OpenDropdown()
    if self._dropdownRoot then
        self:_showDropdown(true)
    end
end

function Icon:CloseDropdown()
    if self._dropdownRoot then
        self:_showDropdown(false)
    end
end

function Icon:ToggleDropdown()
    if self._dropdownRoot then
        self:_showDropdown(not self._dropdownOpen)
    end
end

function Icon:_showDropdown(show)
    if not self._dropdownRoot then return end
    self._dropdownRoot.Visible = show
    self._dropdownOpen = show
    if show then
        self._opened:Fire()
    else
        self._closed:Fire()
    end
end

function Icon:AddDropdown(opts)
    -- opts: {Title = "Title", Items = { {Text="x", Callback = fn}, ... } }
    if self._dropdownRoot then self._dropdownRoot:Destroy() end
    local root = Instance.new("Frame")
    root.Name = "DropdownRoot"
    root.Size = UDim2.new(0, 180, 0, 28)
    root.AnchorPoint = Vector2.new(1, 0)
    root.BackgroundTransparency = 0.1
    root.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    root.BorderSizePixel = 0
    root.Visible = false

    -- Position right under icon
    root.Position = UDim2.new(0, 0, 0, 40)
    root.Parent = self._root

    local layout = Instance.new("UIListLayout")
    layout.FillDirection = Enum.FillDirection.Vertical
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0, 4)
    layout.Parent = root

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -8, 0, 24)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Text = opts.Title or ""
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextSize = 14
    titleLabel.TextColor3 = Color3.new(1,1,1)
    titleLabel.LayoutOrder = 0
    titleLabel.Parent = root

    local items = opts.Items or {}
    local order = 1
    for _,it in ipairs(items) do
        local b = Instance.new("TextButton")
        b.Size = UDim2.new(1, -8, 0, 28)
        b.BackgroundTransparency = 0.2
        b.Text = it.Text or "Item"
        b.Font = Enum.Font.SourceSans
        b.TextSize = 14
        b.TextColor3 = Color3.new(1,1,1)
        b.LayoutOrder = order
        b.Parent = root
        order = order + 1

        b.MouseButton1Click:Connect(function()
            -- close dropdown and call callback
            self:_showDropdown(false)
            if type(it.Callback) == "function" then
                task.spawn(it.Callback)
            end
        end)
    end

    -- auto size root frame height
    RunService.Heartbeat:Wait()
    local total = 0
    for _,child in ipairs(root:GetChildren()) do
        if child:IsA("TextLabel") or child:IsA("TextButton") then
            total = total + child.Size.Y.Offset + layout.Padding.Offset
        end
    end
    root.Size = UDim2.new(0, 180, 0, math.max(28, total + 8))

    self._dropdownRoot = root
    self._dropdownOpen = false
    return root
end

function Icon:Update(opts)
    if opts.Title then
        self._title = opts.Title
    end
    if opts.Image then
        self._img = opts.Image
        if self._btn then self._btn.Image = opts.Image end
    end
    if opts.Enabled ~= nil then
        self:SetEnabled(opts.Enabled)
    end
end

-- public API: newIcon(name, options)
-- options: {Title="", Image="rbxassetid://", Enabled=true}
function Topbar.newIcon(name, options)
    options = options or {}
    local player = Players.LocalPlayer
    if not player then
        warn("TopbarPlusClone: LocalPlayer not ready")
        return nil
    end

    local gui = createGuiForPlayer(player)
    local container = gui:WaitForChild("Container")

    -- root frame to anchor dropdown
    local root = Instance.new("Frame")
    root.Name = ("IconRoot_%s"):format(name)
    root.BackgroundTransparency = 1
    root.Size = UDim2.new(0, 34, 0, 34)
    root.Parent = container

    local btn = Instance.new("ImageButton")
    btn.Name = "IconButton"
    btn.Size = UDim2.new(0, 34, 0, 34)
    btn.Position = UDim2.new(1, -34, 0, 0)
    btn.AnchorPoint = Vector2.new(1, 0)
    btn.BackgroundTransparency = 0.15
    btn.Image = options.Image or ""
    btn.ScaleType = Enum.ScaleType.Fit
    btn.Parent = root

    -- simple hover effect (no external libs)
    btn.MouseEnter:Connect(function() btn.BackgroundTransparency = 0.05 end)
    btn.MouseLeave:Connect(function() btn.BackgroundTransparency = 0.15 end)

    local iconObj = setmetatable({
        Name = name,
        _root = root,
        _btn = btn,
        _title = options.Title or name,
        _img = options.Image or "",
        _enabled = options.Enabled ~= false,
        _clicked = makeSignal(),
        _opened = makeSignal(),
        _closed = makeSignal(),
    }, Icon)

    -- click behavior
    btn.MouseButton1Click:Connect(function()
        if not iconObj._enabled then return end
        iconObj._clicked:Fire(iconObj)
    end)

    -- close dropdown if click elsewhere
    local function onGlobalClick()
        if iconObj._dropdownRoot and iconObj._dropdownOpen then
            iconObj:_showDropdown(false)
        end
    end
    -- connect a global invisible button
    local globalBtn = Instance.new("TextButton")
    globalBtn.Name = "GlobalClose"
    globalBtn.BackgroundTransparency = 1
    globalBtn.Size = UDim2.new(1,0,1,0)
    globalBtn.Position = UDim2.new(0,0,0,0)
    globalBtn.Parent = gui
    globalBtn.ZIndex = 0
    -- ensure we don't block input to other UIs: capture only when dropdown is open
    globalBtn.MouseButton1Click:Connect(function()
        onGlobalClick()
    end)
    -- hide the global button (we'll toggle visibility)
    globalBtn.Visible = false

    -- when opening dropdown, toggle globalBtn visible to detect outside clicks
    iconObj._opened:Connect(function()
        globalBtn.Visible = true
    end)
    iconObj._closed:Connect(function()
        globalBtn.Visible = false
    end)

    -- attach helper methods for events
    function iconObj.clicked() return iconObj._clicked end
    function iconObj.opened() return iconObj._opened end
    function iconObj.closed() return iconObj._closed end

    -- expose UI root for advanced customizations
    iconObj.UI = root

    -- default enabled state
    iconObj:SetEnabled(iconObj._enabled)

    -- briefly yield to allow layout to apply
    RunService.Heartbeat:Wait()

    return iconObj
end

return Topbar
